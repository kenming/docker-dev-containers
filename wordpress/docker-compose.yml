services:
  mysql_server:
    image: mysql:${MYSQL_VERSION:-5.7.44}
    container_name: ${MYSQL_CONTAINER_NAME:-wordpress_db}
    restart: always
    volumes:
      - ${MYSQL_DATA_DIR:-~/docker-vols/db_data/mysql}:/var/lib/mysql
    environment:      
      - MYSQL_DATABASE=${MYSQL_DATABASE:-wp_blog}
      - MYSQL_USER=${MYSQL_USER:-wpuser}
      - MYSQL_PASSWORD=${MYSQL_PASSWORD}
      - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD}
  
  phpmyadmin:
    image: phpmyadmin:${PMA_VERSION:-5.2.1}
    container_name: ${PMA_CONTAINER_NAME:-phpmyadmin}
    links:
      - mysql_server
    restart: always
    environment:
      - VIRTUAL_HOST=${PMA_VIRTUAL_HOST:-phpmyadmin.test}
      - PMA_HOST=mysql_server
      - PMA_PORT=3306
      - MYSQL_USERNAME=root
      - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD}
      - UPLOAD_LIMIT=${PMA_UPLOAD_LIMIT:-500M}
    #volumes: 
    #  - ./phpmyadmin/phpmyadmin-misc.ini:/usr/local/etc/php/conf.d/phpmyadmin-misc.ini
    depends_on:
      - mysql_server
    expose:
      - 80

  wordprss_blog:
    image: wordpress:${WP_BLOG_VERSION:-php8.3}
    container_name: ${WP_BLOG_CONTAINER_NAME:-wordpress_blog}
    restart: always
    environment:
      - VIRTUAL_HOST=${WP_BLOG_VIRTUAL_HOST:-blog.test}
      - WORDPRESS_DB_NAME=${WP_BLOG_DB_NAME:-wp_blog}
      - WORDPRESS_DB_HOST=mysql_server:3306
      - WORDPRESS_DB_USER=${MYSQL_USER:-wpuser}
      - WORDPRESS_DB_PASSWORD=${MYSQL_PASSWORD}
      - WORDPRESS_DEBUG=${WP_BLOG_DEBUG:-false}
    volumes:
      - ${WP_BLOG_DIR:-~/docker-vols/sites/blog}:/var/www/html
    depends_on:
      - mysql_server
    expose:
      - 80

  wordprss_kenming:    
    build:
      context: ./wp-base
      args:
        WP_VERSION: ${WP_KENMING_VERSION:-php8.3}
    container_name: ${WP_KENMING_CONTAINER_NAME:-wordpress_kenming}
    restart: always
    environment:
      - VIRTUAL_HOST=${WP_KENMING_VIRTUAL_HOST:-kenming.test}      
      - WORDPRESS_DB_NAME=${WP_KENMING_DB_NAME:-wp_kenming}
      - WORDPRESS_DB_HOST=mysql_server:3306
      - WORDPRESS_DB_USER=${MYSQL_USER:-wpuser}
      - WORDPRESS_DB_PASSWORD=${MYSQL_PASSWORD}
      - WORDPRESS_DEBUG=${WP_KENMING_DEBUG:-false}
    volumes:
      - ${WP_KENMING_DIR:-~/docker-vols/sites/kenming}:/var/www/html
      - ~/docker-vols/php/kenming/custom-php.ini:/usr/local/etc/php/conf.d/custom-php.ini
      # - ~/.local/share/mkcert/rootCA.pem:/usr/local/share/ca-certificates/mkcert-rootCA.crt:ro
    depends_on:
      - mysql_server
    expose:
      - 80
    extra_hosts:
      - "kenming.test:host-gateway"

  wordpress_wpdev:  # ä¿®æ­£æ‹¼å­— (wordprss -> wordpress)
    build:
      context: ./wp-base # ç¢ºèªé€™è£¡é¢æœ‰æ‚¨çš„ Dockerfile å’Œ mkcert-rootCA.pem
      args:
        # ä¿®æ­£ï¼šè®Šæ•¸æ”¹ç‚ºå…¨å¤§å¯«ï¼Œå°æ‡‰ .env
        WP_VERSION: ${WP_WPDEV_VERSION:-php8.3}
    
    # ä¿®æ­£ï¼šè®Šæ•¸æ”¹ç‚ºå…¨å¤§å¯«
    container_name: ${WP_WPDEV_CONTAINER_NAME:-wordpress_wpdev}
    restart: always
    environment:
      # ä¿®æ­£ï¼šè®Šæ•¸æ”¹ç‚ºå…¨å¤§å¯«
      - VIRTUAL_HOST=${WP_WPDEV_VIRTUAL_HOST:-wpdev.test}      
      # ä¿®æ­£ï¼šè®Šæ•¸æ”¹ç‚ºå…¨å¤§å¯«
      - WORDPRESS_DB_NAME=${WP_WPDEV_DB_NAME:-wp_wpdev}
      - WORDPRESS_DB_HOST=mysql_server:3306
      - WORDPRESS_DB_USER=${MYSQL_USER:-wpuser}
      - WORDPRESS_DB_PASSWORD=${MYSQL_PASSWORD}
      
      # Debug è¨­å®š
      - WORDPRESS_DEBUG=${WP_WPDEV_DEBUG:-true}
      # ä¿®æ­£ï¼šé€™è£¡æ‡‰è©²å¼•ç”¨ LOG çš„å°ˆç”¨è®Šæ•¸
      - WORDPRESS_DEBUG_LOG=${WP_WPDEV_DEBUG_LOG:-true}
      
    volumes:
      # ç¶²ç«™æ ¹ç›®éŒ„
      - ${WP_WPDEV_DIR:-~/docker-vols/sites/wpdev}:/var/www/html
      # PHP è¨­å®š
      - ~/docker-vols/php/wpdev/custom-php.ini:/usr/local/etc/php/conf.d/custom-php.ini
      # ğŸ”Œ æ’ä»¶é–‹ç™¼æ›è¼‰ 
      - ~/projects/wpdev/plugins/aixpert-marklite:/var/www/html/wp-content/plugins/aixpert-marklite
      
    depends_on:
      - mysql_server
    expose:
      - 80
    extra_hosts:
      - "wpdev.test:host-gateway"      

  image_server:
      image: nginx:alpine  # ä½¿ç”¨æœ€è¼•é‡çš„ Nginx åœ–ç‰‡
      container_name: ${IMAGE_SERVER_CONTAINER_NAME:-image_kenming}
      restart: always
      environment:
        # âš ï¸ é—œéµï¼šå‘Šè¨´ nginx-proxy é€™å€‹å®¹å™¨è¦éŸ¿æ‡‰å“ªå€‹åŸŸå
        - VIRTUAL_HOST=images.kenming.idv.tw
        - VIRTUAL_PORT=80
      volumes:
        # âš ï¸ é—œéµï¼šå°‡æ‚¨çš„æœ¬æ©Ÿåœ–ç‰‡è³‡æ–™å¤¾æ›è¼‰åˆ°å®¹å™¨çš„é è¨­ Nginx æ ¹ç›®éŒ„
        - ${IMAGE_DIR:-~/docker-vols/sites/image_kenming}:/usr/share/nginx/html:ro
      expose:
        - 80

networks:
  default:
    external: true
    name: ${NETWORK_NAME:-nginx-proxy}